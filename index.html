<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>专转 拽专 - 专 砖专 </title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: all 0.3s ease; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: left 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-left: 2.5rem; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <header class="bg-indigo-600 text-white p-6 shadow-lg">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center">
            <div class="text-center md:text-right mb-4 md:mb-0">
                <h1 class="text-3xl font-bold"> 专 砖专  - 转 '</h1>
                <p class="mt-2 text-indigo-100 opacity-90">转, 转拽  拽专!</p>
            </div>
            
            <div class="w-full md:w-1/3">
                <label for="student-select" class="block text-sm font-medium text-indigo-100 mb-1">爪 转 注专:</label>
                <select id="student-select" class="block w-full bg-white text-gray-900 border border-gray-300 rounded-lg py-3 px-4 focus:ring-2 focus:ring-indigo-400 focus:outline-none shadow-sm font-semibold">
                    <option value="all"> 转 (住 )</option>
                    </select>
            </div>
        </div>
    </header>

    <div class="max-w-6xl mx-auto p-4 space-y-6">

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="card p-6 text-center border-b-4 border-green-500">
                <h2 class="text-gray-500 font-semibold mb-2">住" 拽转 拽专</h2>
                <div id="total-minutes" class="text-5xl font-bold text-green-600">...</div>
                <p id="minutes-subtitle" class="text-sm text-gray-400 mt-2">注 砖: 1000 拽转!</p>
            </div>

            <div class="card p-6 text-center border-b-4 border-blue-500">
                <h2 class="text-gray-500 font-semibold mb-2">住驻专 </h2>
                <div id="total-workouts" class="text-5xl font-bold text-blue-600">...</div>
                <p class="text-sm text-gray-400 mt-2"> 砖</p>
            </div>

            <div class="card p-6 text-center border-b-4 border-purple-500">
                <h2 class="text-gray-500 font-semibold mb-2">转 驻注</h2>
                <div id="active-students" class="text-5xl font-bold text-purple-600">...</div>
                <p class="text-sm text-gray-400 mt-2">砖转转驻 转专</p>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="card p-6">
                <h2 class="text-xl font-bold mb-4 text-gray-700 flex items-center">
                     转拽转 专 
                </h2>
                <div class="h-64">
                    <canvas id="readingChart"></canvas>
                </div>
            </div>

            <div class="card p-6">
                <h2 class="text-xl font-bold mb-4 text-gray-700 flex items-center">
                    グ 转 拽专 (专砖转)
                </h2>
                <div class="h-64 flex justify-center">
                    <canvas id="moodChart"></canvas>
                </div>
            </div>
        </div>

        <div class="card p-6 overflow-hidden">
            <h2 class="text-xl font-bold mb-4 text-gray-700">  拽专 驻专</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full text-right">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="py-3 px-4 font-semibold text-gray-600">转专</th>
                            <th class="py-3 px-4 font-semibold text-gray-600">砖 转/</th>
                            <th class="py-3 px-4 font-semibold text-gray-600">砖 住驻专</th>
                            <th class="py-3 px-4 font-semibold text-gray-600"></th>
                            <th class="py-3 px-4 font-semibold text-gray-600">拽转</th>
                        </tr>
                    </thead>
                    <tbody id="log-table-body" class="divide-y divide-gray-100">
                        </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // 砖转  砖专转 转 专驻
        let allData = []; 
        let barChart = null;
        let pieChart = null;

        const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS7Ef224-e8pl9hy_11eOY3QGy3JX4plIeurKRjQscqRhlXrYR9Aera79dcgbYqx6so_SZ_asei0S7h/pub?gid=379096617&single=true&output=csv';

        Papa.parse(sheetUrl, {
            download: true,
            header: true,
            complete: function(results) {
                // 砖专转 专拽 砖专转 转拽转 (砖砖  砖 拽转)
                allData = results.data.filter(row => row['砖 转/'] && row['拽转']);
                initDashboard();
            }
        });

        function initDashboard() {
            populateStudentDropdown();
            updateDashboard('all'); // 注 专砖转 砖  转

            //  砖 专转 转
            document.getElementById('student-select').addEventListener('change', (e) => {
                updateDashboard(e.target.value);
            });
        }

        //  专砖转 转 ()
        function populateStudentDropdown() {
            const students = [...new Set(allData.map(d => d['砖 转/'].trim()))].sort();
            const select = document.getElementById('student-select');
            
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student;
                option.textContent = student;
                select.appendChild(option);
            });
        }

        // 驻拽爪 专转 砖注转 转  住
        function updateDashboard(selectedStudent) {
            
            // 1. 住 转 驻 专
            let filteredData = allData;
            if (selectedStudent !== 'all') {
                filteredData = allData.filter(d => d['砖 转/'].trim() === selectedStudent);
            }

            // 2. 砖 住住拽转
            let totalMinutes = 0;
            let totalWorkouts = filteredData.length;
            let dailyData = {};
            let moodData = {};

            // 砖转 住驻专转 转  ( 专 " 转")
            let uniqueStudents = new Set(filteredData.map(d => d['砖 转/'])).size;

            filteredData.forEach(row => {
                const mins = parseInt(row['拽转']) || 0;
                totalMinutes += mins;

                //  专祝 
                const date = row['转专']; //  砖 驻专 
                dailyData[date] = (dailyData[date] || 0) + mins;

                //  专祝 专砖转
                // 砖转砖 注 " 专砖/" (flow)
                let mood = row[' 专砖/'] || row['flow'] || ' 爪';
                moodData[mood] = (moodData[mood] || 0) + 1;
            });

            // 3. 注 专住 注
            document.getElementById('total-minutes').innerText = totalMinutes.toLocaleString();
            document.getElementById('total-workouts').innerText = totalWorkouts.toLocaleString();
            
            // 注 专住 砖砖:   转 , 专 转 爪注 拽转 砖,   转 - 住驻专 转
            if (selectedStudent === 'all') {
                 document.getElementById('active-students').innerText = uniqueStudents;
                 document.getElementById('active-students').parentElement.querySelector('h2').innerText = "转 驻注";
            } else {
                 let avg = totalWorkouts > 0 ? Math.round(totalMinutes / totalWorkouts) : 0;
                 document.getElementById('active-students').innerText = avg;
                 document.getElementById('active-students').parentElement.querySelector('h2').innerText = "爪注  (拽')";
            }

            // 4. 注 专驻
            renderBarChart(dailyData);
            renderPieChart(moodData);

            // 5. 注 
            renderTable(filteredData);
        }

        function renderBarChart(dailyData) {
            const ctx = document.getElementById('readingChart').getContext('2d');
            
            //  专 砖 专祝, 爪专 专住 转 驻 砖爪专 砖
            if (barChart) barChart.destroy();

            barChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(dailyData),
                    datasets: [{
                        label: '拽转 拽专',
                        data: Object.values(dailyData),
                        backgroundColor: '#6366f1',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function renderPieChart(moodData) {
            const ctx = document.getElementById('moodChart').getContext('2d');
            
            if (pieChart) pieChart.destroy();

            // 爪注 驻 专祝 驻
            const colors = ['#34d399', '#60a5fa', '#f472b6', '#fbbf24', '#a78bfa', '#9ca3af'];

            pieChart = new Chart(ctx, {
                type: 'doughnut', // 住 "" 专 转专
                data: {
                    labels: Object.keys(moodData),
                    datasets: [{
                        data: Object.values(moodData),
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { position: 'right' } // 拽专 爪
                    }
                }
            });
        }

        function renderTable(data) {
            const tbody = document.getElementById('log-table-body');
            tbody.innerHTML = '';

            // 爪 转 转 砖 转专 注
            const sortedData = data.slice().reverse();

            sortedData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition-colors";
                tr.innerHTML = `
                    <td class="py-3 px-4 border-b text-gray-500 text-sm">${row['转专']}</td>
                    <td class="py-3 px-4 border-b font-medium text-gray-800">${row['砖 转/']}</td>
                    <td class="py-3 px-4 border-b text-gray-600">${row[' 拽专/']}</td>
                    <td class="py-3 px-4 border-b text-gray-500 text-sm"><span class="bg-blue-100 text-blue-800 py-1 px-2 rounded-full text-xs">${row[' 专砖/'] || row['flow'] || '-'}</span></td>
                    <td class="py-3 px-4 border-b font-bold text-indigo-600">${row['拽转']}</td>
                `;
                tbody.appendChild(tr);
            });
        }
    </script>
</body>
</html>
